

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Software Architecture &mdash; ESP32 Ma Bell Gateway 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=edc13519" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="State Machine" href="state-machine.html" />
    <link rel="prev" title="Software Design" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ESP32 Ma Bell Gateway
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../standards.html">Telephone Service Standards</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../solution-design.html">Solution Design</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../esp32-microcontroller.html">ESP32 Microcontroller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../circuit/index.html">Circuit Design</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Software Design</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Software Architecture</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#core-subsystems">Core Subsystems</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cross-cutting-concerns">Cross-Cutting Concerns</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="state-machine.html">State Machine</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../enclosure/index.html">Enclosure Design</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../implementation.html">Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">User Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ESP32 Ma Bell Gateway</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../solution-design.html">Solution Design</a></li>
          <li class="breadcrumb-item"><a href="index.html">Software Design</a></li>
      <li class="breadcrumb-item active">Software Architecture</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/solution-design/software/software-architecture.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="software-architecture">
<h1>Software Architecture<a class="headerlink" href="#software-architecture" title="Link to this heading"></a></h1>
<p>The Ma Bell Gateway firmware is a modular ESP32 application built with the ESP-IDF framework. It integrates multiple subsystems to deliver an authentic analog telephone experience—powered by Bluetooth audio, digital signal processing, and classic signaling emulation.</p>
<p>This section outlines the major software components, task structure, and interfaces. Each subsystem is implemented using event-driven FreeRTOS tasks, ESP-IDF drivers, and custom glue logic designed to support rotary dial inputs, tone playback, Bluetooth communication, and real-time web monitoring.</p>
<section id="core-subsystems">
<h2>Core Subsystems<a class="headerlink" href="#core-subsystems" title="Link to this heading"></a></h2>
<p>The following high-level modules work together to create the complete experience:</p>
<ul>
<li><p><strong>Bluetooth Hands-Free Profile (HFP)</strong></p>
<p>The <cite>bt_app_core.c</cite>, <cite>bt_app_hf.c</cite>, and <cite>app_hf_msg_set.c</cite> modules manage the Bluetooth stack and AT command exchange via the ESP32’s HFP client interface. These handle pairing, call control, DTMF tone transmission, and audio routing. Events such as <cite>ESP_HF_CLIENT_CALL_SETUP_EVT</cite> and <cite>ESP_HF_CLIENT_AUDIO_STATE_EVT</cite> drive transitions in the call lifecycle.</p>
</li>
<li><p><strong>DTMF Tone Detection</strong></p>
<p>A tone analysis engine captures audio input from the phone line and detects valid DTMF tones using dual-frequency analysis. This is used to extract dialed numbers from tone-based phones, with the decoder module responding to frequency combinations like 697/1209 Hz or 852/1477 Hz. A separate task is responsible for processing real-time samples from the PCM stream.</p>
</li>
<li><p><strong>Pulse Dial Detection</strong></p>
<p>Rotary phones that pulse the line rather than emitting tones are supported via a GPIO-based pulse detector. The pulse input is debounced, timestamped, and interpreted into digit events. This allows full compatibility with pre-touch-tone rotary phones.</p>
</li>
<li><p><strong>Voice Playback and Processing</strong></p>
<p>The firmware supports playback of system sounds (e.g. dial tone, ringback, reorder tone) and may optionally support audio post-processing like echo cancellation. Output is streamed over I2S to a DAC or directly to an audio amplifier, while Bluetooth voice input/output is routed through ringbuffers and callbacks for duplex communication.</p>
</li>
<li><p><strong>Web Interface and Internal State Viewer</strong></p>
<p>A lightweight HTML interface allows internal system state to be queried via an embedded web server. Pages include current connection state, dial history, debug logs, and system metrics. This enables easy monitoring of the Ma Bell Gateway from any device on the network.</p>
</li>
<li><p><strong>Front Panel Display Renderer</strong></p>
<p>A small OLED or LCD panel mounted on the gateway enclosure provides real-time UI feedback. This includes indicators for Bluetooth pairing, call status, battery level (if applicable), or messages such as “Dialing…” or “Connected.” Display updates are queued and rendered from a dedicated FreeRTOS task to ensure responsiveness.</p>
</li>
</ul>
</section>
<section id="cross-cutting-concerns">
<h2>Cross-Cutting Concerns<a class="headerlink" href="#cross-cutting-concerns" title="Link to this heading"></a></h2>
<ul>
<li><p><strong>FreeRTOS Tasks and Message Dispatching</strong></p>
<p>Modules like <cite>bt_app_core</cite> use task queues (<cite>bt_app_task_queue</cite>) and message dispatching to serialize Bluetooth events and actions. This decouples low-level driver callbacks from higher-level logic, improving maintainability and system stability.</p>
</li>
<li><p><strong>Hardware I/O</strong></p>
<p>GPIOs are configured in <cite>gpio_pcm_config.c</cite> to route PCM audio signals, detect pulses, and optionally support acoustic echo cancellation. External pins are mapped using <cite>esp_rom_gpio_connect_*</cite> calls for tight integration with ESP32 signal routing.</p>
</li>
<li><p><strong>Configuration and Command Console</strong></p>
<p>Developers can interact with the system over UART using a built-in command console based on <cite>esp_console</cite>. Commands allow manual call control, audio routing, DTMF sending, and testing of subsystems without relying on the physical phone interface.</p>
</li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Software Design" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="state-machine.html" class="btn btn-neutral float-right" title="State Machine" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Chris Deever.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>